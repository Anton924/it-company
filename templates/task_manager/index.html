{% extends "base.html" %}
{% load static %}

{% block title %}
  Dashboard
{% endblock %}

{% block content %}
  <div class="container-fluid py-4">

   <div class="row mb-4">

    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
       <div class="card-header p-3 pt-2">
        <div class="icon icon-lg icon-shape bg-gradient-info shadow-info text-center border-radius-xl mt-n4 position-absolute">
         <i class="material-symbols-rounded opacity-10">task</i>
        </div>
        <div class="text-end pt-1">
         <p class="text-sm mb-0 text-capitalize">Tasks in progress</p>
         <h4 class="mb-0">{{ total_tasks_in_process }}</h4>
        </div>
       </div>
       <hr class="dark horizontal my-0">
       <div class="card-footer p-3">
        <p class="mb-0 text-sm"><span class="text-success text-sm font-weight-bolder">Active</span> workloads</p>
       </div>
      </div>
    </div>

    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
       <div class="card-header p-3 pt-2">
        <div class="icon icon-lg icon-shape bg-gradient-primary shadow-primary text-center border-radius-xl mt-n4 position-absolute">
         <i class="material-symbols-rounded opacity-10">inventory_2</i>
        </div>
        <div class="text-end pt-1">
         <p class="text-sm mb-0 text-capitalize">Active Projects</p>
         <h4 class="mb-0">{{ total_projects }}</h4>
        </div>
       </div>
       <hr class="dark horizontal my-0">
       <div class="card-footer p-3">
         <p class="mb-0 text-sm">Global status</p>
       </div>
      </div>
    </div>

    <div class="col-xl-3 col-sm-6 mb-xl-0 mb-4">
      <div class="card">
       <div class="card-header p-3 pt-2">
        <div class="icon icon-lg icon-shape bg-gradient-success shadow-success text-center border-radius-xl mt-n4 position-absolute">
         <i class="material-symbols-rounded opacity-10">groups</i>
        </div>
        <div class="text-end pt-1">
         <p class="text-sm mb-0 text-capitalize">Team Members</p>
         <h4 class="mb-0">{{ total_workers }}</h4>
        </div>
       </div>
       <hr class="dark horizontal my-0">
       <div class="card-footer p-3">
        <p class="mb-0 text-sm">Registered users</p>
       </div>
      </div>
    </div>

    <div class="col-xl-3 col-sm-6">
      <div class="card">
       <div class="card-header p-3 pt-2">
        <div class="icon icon-lg icon-shape bg-gradient-warning shadow-warning text-center border-radius-xl mt-n4 position-absolute">
         <i class="material-symbols-rounded opacity-10">person_pin_circle</i>
        </div>
        <div class="text-end pt-1">
         <p class="text-sm mb-0 text-capitalize">Visits</p>
         <h4 class="mb-0">{{ visit_times }}</h4>
        </div>
       </div>
       <hr class="dark horizontal my-0">
       <div class="card-footer p-3">
        <p class="mb-0 text-sm">Your session activity</p>
       </div>
      </div>
    </div>
   </div>

   {# ----------------------------- TABLES SECTION ------------------------------------ #}
   <div class="row mb-4">
    {% if request.user.is_authenticated %}

     <div class="col-lg-8 col-md-6 mb-md-0 mb-4">
      <div class="card h-100">
       <div class="card-header pb-0">
        <div class="row">
         <div class="col-lg-6 col-7">
          <h6>Projects Overview</h6>
          <p class="text-sm mb-0">
            <i class="fa fa-check text-info" aria-hidden="true"></i>
            <span class="font-weight-bold ms-1">{{ total_projects }} active</span> this month
          </p>
         </div>
         <div class="col-lg-6 col-5 my-auto text-end">
             </div>
        </div>
       </div>
       <div class="card-body px-0 pb-2">
        <div class="table-responsive">
         <table class="table align-items-center mb-0">
          <thead>
          <tr>
           <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Project Name</th>
           <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Budget</th>
           <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Load (Tasks)</th>
           <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Teams</th>
          </tr>
          </thead>
          <tbody>
          {% for project in projects %}
           <tr>
            <td>
             <div class="d-flex px-2 py-1">
              <div class="d-flex flex-column justify-content-center">
               <h6 class="mb-0 text-sm">{{ project.name }}<i class="material-symbols-rounded text-primary text-sm">open_in_new</i></h6>
              </div>
             </div>
            </td>

            <td class="align-middle text-center text-sm">
             <span class="text-xs font-weight-bold text-secondary">
                 {% if project.budget %}
                    ${{ project.budget }} {% else %}
                    -
                 {% endif %}
             </span>
            </td>

            <td class="align-middle text-center">
              <span class="badge badge-sm bg-gradient-secondary">{{ project.total_tasks }} tasks</span>
            </td>

            <td class="align-middle text-center">
               <span class="text-xs font-weight-bold text-secondary">{{ project.total_teams }}</span>
            </td>
           </tr>
          {% empty %}
           <tr>
            <td colspan="4" class="align-middle text-center py-4">
             <h6 class="mb-0 text-sm text-secondary">No active projects found.</h6>
             <a href="" class="btn btn-sm btn-outline-primary mt-2">Create New</a>
            </td>
           </tr>
          {% endfor %}
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>

    <div class="col-lg-4 col-md-6 mb-md-0 mb-4">
      <div class="card h-100">
       <div class="card-header pb-0">
        <h6>Top Teams</h6>
       </div>
       <div class="card-body px-0 pb-2">
        <div class="table-responsive">
         <table class="table align-items-center mb-0">
          <thead>
          <tr>
           <th class="text-uppercase text-secondary text-xxs font-weight-bolder opacity-7">Team</th>
           <th class="text-center text-uppercase text-secondary text-xxs font-weight-bolder opacity-7 ps-2">Leader</th>
          </tr>
          </thead>
          <tbody>
          {% for team in teams %}
	        <tr>
							<td>
								<a href="{% url "task_manager:team-detail" pk=team.pk %}">
									 <div class="d-flex px-2 py-1">
									  <div class="d-flex flex-column justify-content-center">
									   <h6 class="mb-0 text-sm">{{ team.name }}<i class="material-symbols-rounded text-primary text-sm">open_in_new</i></h6>
									   <p class="text-xs text-secondary mb-0">{{ team.workers.count }} members</p>
									  </div>
									 </div>
								</a>
							</td>

							<td class="align-middle text-center">
							    {% if team.team_lead %}
							    <div class="d-flex align-items-center justify-content-center">
							        <div class="avatar avatar-xs rounded-circle bg-gradient-info me-2" data-bs-toggle="tooltip" title="{{ team.team_lead.first_name|upper }} {{ team.team_lead.last_name|upper }}">
							            <span class="text-white text-xxs">{{ team.team_lead.first_name|first|upper }}{{ team.team_lead.last_name|first|upper }}</span>
							        </div>
							        <span class="text-xs font-weight-bold text-secondary">{{ team.team_lead.username }}</span>
							    </div>
							    {% else %}
							        <span class="text-xs text-secondary">No Lead</span>
							    {% endif %}
							</td>
	        </tr>
          {% empty %}
           <tr>
            <td colspan="3" class="align-middle text-center py-4">
               <span class="text-xs text-secondary">No teams available</span>
            </td>
           </tr>
          {% endfor %}
          </tbody>
         </table>
        </div>
       </div>
      </div>
     </div>
    {% else %}
     <div class="col-12 mt-4">
      <div class="card shadow-lg bg-gray-100">
       <div class="card-body py-5 text-center">
        <div class="icon icon-lg icon-shape bg-gradient-warning shadow-warning rounded-circle mb-3 mx-auto">
            <i class="material-symbols-rounded opacity-10">lock</i>
        </div>
        <h3 class="font-weight-bolder">Access Restricted</h3>
        <p class="text-secondary mb-4">
         You need to be logged in to view the dashboard analytics.
        </p>
        <a href="{% url 'login' %}" class="btn btn-dark mb-0">
            <i class="material-symbols-rounded text-sm me-1">login</i> Sign In
        </a>
       </div>
      </div>
     </div>
    {% endif %}
   </div>
  </div>
{% endblock content %}